name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.21"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade uv
        uv sync --all-extras
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

    - name: Lint Python with ruff
      run: uv run ruff check tpcli_pi/ tests/

    - name: Format check with ruff
      run: uv run ruff format --check tpcli_pi/ tests/

    - name: Type checking with mypy
      run: uv run mypy tpcli_pi/ --strict --ignore-missing-imports

    - name: Lint Go with golangci-lint
      run: golangci-lint run ./...

    - name: Go vet
      run: go vet ./...

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade uv
        uv sync --all-extras

    - name: Run bandit (security linting)
      run: uv run bandit -r tpcli_pi/ -f json -o bandit-report.json || true

    - name: Run semgrep security checks
      run: uv run semgrep --config=p/owasp-top-ten --json -o semgrep-report.json tpcli_pi/ || true

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          semgrep-report.json

  complexity:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade uv
        uv sync --all-extras

    - name: Check code complexity
      run: |
        echo "=== Cyclomatic Complexity ==="
        uv run radon cc tpcli_pi/ -a -nb
        echo "=== Maintainability Index ==="
        uv run radon mi tpcli_pi/ -nb

    - name: Check for code duplication
      run: |
        uv run pylint --disable=all --enable=duplicate-code tpcli_pi/ || true
